<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliciousRecipes - Inicio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../../../styles/general.css">
    <link rel="shortcut icon" href="../../../assets/logo/logo_cocinero.png" type="image/x-icon">
</head>
<body>
    <nav class="navbar navbar-expand-lg px-4 py-2 fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand contenedor_logo d-flex justify-content-center align-items-center" href="#">
                <div class="contenedor_logo_imagen">
                    <img src="../../../assets/logo/logo.png" alt="Gorra de cocinero" class="imagen">
                </div>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end " id="navbarNavDropdown">
                <ul class="contenedor_links navbar-nav d-flex align-items-center">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="../../../index.html">Inicio</a>
                    </li>
                    <li class="nav-item mx-2">
                        <a class="nav-link" href="../../index.html">Recetas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./pages/contacto.html">Contacto</a>
                    </li>
                </ul>
                <button class="btn btn-naranja" id="loginBtn">Iniciar Sesión</button>
                <a class="btn btn-naranja" target="_blank" href="./pages/suscripcion.html" id="suscripcionBtn">Suscribirse</a>
            </div>
            
        </div>
        
    </nav>

    <main class="py-5 my-5">
        <div class="container my-4">
            <div class="row">
                <div class="col-12 col-md-10 col-lg-6 mx-auto">
                    <div class="card p-5">
                        <div class="card-body">
                            <h1 class="fw-bold text-uppercase pb-4">Editar receta</h1>

                            <form id="editRecipeForm"">
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Titulo de receta:</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Milanesa suprema" required>
                                </div>

                                <div class="mb-3">
                                    <label for="descripcion" class="form-label">Descripcion:</label>
                                    <input type="text" class="form-control" id="descripcion" name="descripcion" placeholder="Escriba una descripcion" required>
                                </div>

                                <div class="mb-3">
                                    <label for="instrucciones" class="form-label">Instrucciones:</label>
                                    <input type="text" class="form-control" id="instrucciones" name="instrucciones" placeholder="Escriba una descripcion" required>
                                </div>

                                <div class="mb-3">
                                    <label for="imagen_url" class="form-label">URL de la imagen</label>
                                    <input type="text" class="form-control" name="imagen_url" id="imagen_url" required>
                                </div>

                                <div class="mb-3">
                                    <label for="recetas_ingredientes" class="form-label">Ingredientes</label>
                                    <div id="ingredientsContainer"></div>
                                    <button type="button" class="btn btn_editar_receta mt-3" id="addIngredientBtn">Agregar Ingrediente</button>
                                </div>

                                <button type="submit" class="btn btn-naranja mx-auto my-4">Guardar cambios</button>


                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class=" pt-5 footer px-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <a class="contenedor_logo d-flex justify-content-center align-items-center" href="../../../index.html">
                        <div class="contenedor_logo_imagen">
                            <img src="../../../assets/logo/logo.png" alt="Gorra de cocinero" class="imagen">
                        </div>
                    </a>

                    <div class="contenedor_redes d-flex align-items-center justify-content-center flex-wrap p-3">
                        <i class="bi bi-instagram mx-2 fs-4 icono_ig"></i>
                        <i class="bi bi-facebook mx-2 fs-4 icono_fb"></i>
                        <i class="bi bi-whatsapp mx-2 fs-4 icono_wsp"></i>
                        <i class="bi bi-twitter-x mx-2 fs-4 icono_x"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Sobre nosotros</h5>
                    <p>Somos una comunidad que se dedica a compartir las mejores recetas de cocina. Nuestra misión es inspirar y facilitar la preparación de deliciosos platillos en casa.</p>
                </div>
                <div class="col-md-4">
                    <ul class="list-unstyled">
                        <li><a href="#" class="link_footer">Inicio</a></li>
                        <li><a href="#" class="link_footer">Recetas</a></li>
                        <li><a href="#" class="link_footer">Contacto</a></li>
                    </ul>
                </div>

            </div>

            <div class="text-center py-3">
                <small>&copy; 2024 Delicius Recipes - Todos los derechos reservados.</small>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="./scripts/script.js"></script>

    <script>
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        
        if (id === null) {
            window.location.href = './';
        }

        function handle_get_response(data) {
            document.getElementById("nombre").value = data.nombre;
            document.getElementById("descripcion").value = data.descripcion;
            document.getElementById("instrucciones").value = data.instrucciones;
            document.getElementById("imagen_url").value = data.imagen_url;
            
            data.ingredientes.forEach(ingredient => {
                addIngredientField(ingredient);
            });
        }

        function addIngredientField(ingredient = {cantidad: '', unidad: '', nombre: ''}) {
            const ingredientsContainer = document.getElementById('ingredientsContainer');

            const ingredientDiv = document.createElement('div');
            ingredientDiv.setAttribute('class', 'mb-2 d-flex align-items-center');

            const cantidadInput = document.createElement('input');
            cantidadInput.type = 'text';
            cantidadInput.name = 'cantidad';
            cantidadInput.setAttribute("class", "form-control me-2")
            cantidadInput.placeholder = 'Cantidad';
            cantidadInput.value = ingredient.cantidad;

            const unidadInput = document.createElement('input');
            unidadInput.type = 'text';
            unidadInput.name = 'unidad';
            unidadInput.setAttribute("class", "form-control me-2")
            unidadInput.placeholder = 'Unidad';
            unidadInput.value = ingredient.unidad;

            const nombreInput = document.createElement('input');
            nombreInput.type = 'text';
            nombreInput.name = 'nombre';
            nombreInput.setAttribute("class", "form-control me-2")
            nombreInput.placeholder = 'Nombre';
            nombreInput.value = ingredient.nombre;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.setAttribute("class", "btn btn-danger")
            removeBtn.textContent = 'Eliminar';
            removeBtn.onclick = () => ingredientDiv.remove();

            ingredientDiv.append(cantidadInput);
            ingredientDiv.append(unidadInput);
            ingredientDiv.append(nombreInput);
            ingredientDiv.append(removeBtn);

            ingredientsContainer.append(ingredientDiv);
        }

        document.getElementById('addIngredientBtn').addEventListener('click', () => addIngredientField());


        function handle_response(data) {
            if (data.success) {
                alert('Cambios guardados exitosamente"');
                window.location.href = `index.html?id=${data.id_receta}`;
            } else {
                console.log('error');
            }
        }

        function edit_recipe(event) {
            event.preventDefault()

            const formData = new FormData(event.target)
            const id_receta = id;
            const nombre = formData.get("nombre");
            const descripcion = formData.get("descripcion");
            const instrucciones = formData.get("instrucciones");
            const imagen_url = formData.get("imagen_url");
            
            const ingredients = [];
            document.querySelectorAll('#ingredientsContainer div').forEach(div => {
                const cantidad = div.querySelector('[name="cantidad"]').value;
                const unidad = div.querySelector('[name="unidad"]').value;
                const nombre = div.querySelector('[name="nombre"]').value;
                ingredients.push({ cantidad, unidad, nombre });
            });


            fetch(`http://localhost:5000/recetas/${id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id_receta: id_receta,
                    nombre: nombre,
                    descripcion: descripcion,
                    instrucciones: instrucciones,
                    imagen_url: imagen_url,
                    ingredientes: ingredients
                })
            })
                .then((res) => res.json())
                .then(handle_response)
                .catch((error) => console.log("ERROR", error))
            }

        document.getElementById('editRecipeForm').addEventListener('submit', edit_recipe);
        
        document.addEventListener('DOMContentLoaded', () => {
            fetch(`http://localhost:5000/recetas/${id}`)
                .then((res) => res.json())
                .then(handle_get_response)
                .catch((error) => console.log("ERROR", error))
        });

    </script>
</body>
</html>